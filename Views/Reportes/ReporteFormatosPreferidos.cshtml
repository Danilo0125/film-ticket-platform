@model List<ASP_MVC_Prueba.Models.ReporteFormatoViewModel>
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Reporte de Formatos Preferidos";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="m-0"><i class="fas fa-tv me-2"></i>Preferencia de Formatos</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-7">
                        <div class="chart-container" style="position: relative; height:300px; width:100%">
                            <canvas id="formatosChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="m-0">Análisis de Preferencias</h6>
                            </div>
                            <div class="card-body">
                                <p>
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    Se analizaron <strong>@Model.Sum(f => f.CantidadPeliculas)</strong> películas en <strong>@Model.Count</strong> formatos diferentes.
                                </p>
                                
                                <p>
                                    <i class="fas fa-chart-pie me-2 text-success"></i>
                                    El formato más popular es <strong>@(Model.FirstOrDefault()?.Formato ?? "N/A")</strong> 
                                    con un <strong>@(Model.FirstOrDefault()?.PorcentajePreferencia.ToString("0.0") ?? "0.0")%</strong> 
                                    de preferencia según tickets vendidos.
                                </p>
                                
                                <p>
                                    <i class="fas fa-ticket-alt me-2 text-warning"></i>
                                    Se vendieron <strong>@Model.Sum(f => f.TotalTickets)</strong> tickets 
                                    generando <strong>$@Model.Sum(f => f.IngresosTotales).ToString("N2")</strong> en ingresos.
                                </p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-lightbulb me-2"></i>Nota importante:</h6>
                            <p class="mb-0">
                                Los formatos se determinan según el tipo de sala donde se proyectó la película (2D, 3D o 4D).
                                Esta métrica refleja las preferencias reales de los clientes basadas en las ventas de tickets.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-list me-2"></i>Detalle de Formatos</h6>
        <div>
            <button class="btn btn-sm btn-outline-primary" onclick="exportarPDF()">
                <i class="fas fa-file-pdf me-1"></i> Exportar PDF
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="exportarExcel()">
                <i class="fas fa-file-excel me-1"></i> Exportar EXCEL
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="exportarCSV()">
                <i class="fas fa-file-csv me-1"></i> Exportar CSV
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (ViewBag.ErrorMessage != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>@ViewBag.ErrorMessage
            </div>
        }
        
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="reporteTable" width="100%" cellspacing="0">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center">Formato</th>
                        <th class="text-center">Películas</th>
                        <th class="text-center">Tickets Vendidos</th>
                        <th class="text-center">% Preferencia</th>
                        <th class="text-end">Ingresos Totales</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="text-center">
                                    <span class="badge @(item.Formato == "2D" ? "bg-primary" : item.Formato == "3D" ? "bg-success" : "bg-danger")">
                                        @item.Formato
                                    </span>
                                </td>
                                <td class="text-center">@item.CantidadPeliculas</td>
                                <td class="text-center">
                                    <span class="badge bg-info">@item.TotalTickets</span>
                                </td>
                                <td class="text-center">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar @(item.Formato == "2D" ? "bg-primary" : item.Formato == "3D" ? "bg-success" : "bg-danger")" 
                                             role="progressbar" style="width: @item.PorcentajePreferencia%;" 
                                             aria-valuenow="@item.PorcentajePreferencia" aria-valuemin="0" aria-valuemax="100">
                                            @item.PorcentajePreferencia.ToString("0.0")%
                                        </div>
                                    </div>
                                </td>
                                <td class="text-end">@item.IngresosTotales.ToString("N2") Bs</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center">
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="2" class="text-end">TOTALES:</th>
                        <th class="text-center">@Model.Sum(f => f.TotalTickets)</th>
                        <th class="text-center">100%</th>
                        <th class="text-end">@Model.Sum(f => f.IngresosTotales).ToString("N2") Bs</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Datos para el gráfico de formatos
            const formatosData = @Html.Raw(Json.Serialize(Model.Select(f => new { label = f.Formato, value = f.TotalTickets })));
            
            // Gráfico de formatos
            const ctxFormatos = document.getElementById('formatosChart').getContext('2d');
            new Chart(ctxFormatos, {
                type: 'doughnut',
                data: {
                    labels: formatosData.map(f => f.label),
                    datasets: [{
                        label: 'Tickets vendidos',
                        data: formatosData.map(f => f.value),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 206, 86, 1)',
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Distribución de Ventas por Formato'
                        }
                    }
                }
            });
        });
        
        function exportarPDF() {
            // Create a form to submit for PDF download
            var form = document.createElement('form');
            form.method = 'post';
            form.action = '@Url.Action("ExportReporte", "Reportes")';
            form.style.display = 'none';
            
            // Add report type
            var reportTypeInput = document.createElement('input');
            reportTypeInput.type = 'hidden';
            reportTypeInput.name = 'ReportType';
            reportTypeInput.value = 'Formatos';
            form.appendChild(reportTypeInput);
            
            // Add format type
            var formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'Format';
            formatInput.value = 'PDF';
            form.appendChild(formatInput);
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function exportarExcel() {
            // Create a form to submit for Excel download
            var form = document.createElement('form');
            form.method = 'post';
            form.action = '@Url.Action("ExportReporte", "Reportes")';
            form.style.display = 'none';
            
            // Add report type
            var reportTypeInput = document.createElement('input');
            reportTypeInput.type = 'hidden';
            reportTypeInput.name = 'ReportType';
            reportTypeInput.value = 'Formatos';
            form.appendChild(reportTypeInput);
            
            // Add format type
            var formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'Format';
            formatInput.value = 'Excel';
            form.appendChild(formatInput);
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        function exportarCSV() {
            // Create a form to submit for CSV download
            var form = document.createElement('form');
            form.method = 'post';
            form.action = '@Url.Action("ExportReporte", "Reportes")';
            form.style.display = 'none';
            
            // Add report type
            var reportTypeInput = document.createElement('input');
            reportTypeInput.type = 'hidden';
            reportTypeInput.name = 'ReportType';
            reportTypeInput.value = 'Formatos';
            form.appendChild(reportTypeInput);
            
            // Add format type
            var formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'Format';
            formatInput.value = 'CSV';
            form.appendChild(formatInput);
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }
    </script>
}
